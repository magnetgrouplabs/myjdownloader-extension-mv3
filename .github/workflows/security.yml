name: Security - Extension Scanning

on:
  schedule:
    - cron: '0 0 * * 0' # Weekly on Sunday
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  dependency-check:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Check Third-Party Libraries
      run: |
        echo "üì¶ Checking third-party libraries..."
        
        # List vendor directory contents
        if [ -d "vendor" ]; then
          echo "Vendor libraries:"
          find vendor -type f -name "*.js" -o -name "*.css" | head -20
        fi
        
        # Check for known vulnerable patterns
        vulnerable_patterns=(
          "eval("
          "Function("
          "document.write"
          "innerHTML"
          "outerHTML"
        )
        
        for pattern in "${vulnerable_patterns[@]}"; do
          if grep -r "$pattern" --include="*.js" --include="*.html" . | grep -v "vendor" | grep -v "_locales"; then
            echo "‚ö†Ô∏è  Found potential XSS pattern: $pattern"
          fi
        done
        
        echo "‚úÖ Dependency check completed"

  manifest-audit:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Manifest Security Audit
      run: |
        echo "üîç Auditing manifest.json security..."
        
        # Check for overly broad permissions
        if grep -q '"<all_urls>"' manifest.json; then
          echo "‚ö†Ô∏è  Using <all_urls> permission - ensure this is necessary"
        fi
        
        # Check content script security
        if grep -q '"all_frames": true' manifest.json; then
          echo "‚ö†Ô∏è  Content scripts running in all frames - ensure this is safe"
        fi
        
        # Check web_accessible_resources
        if grep -q '"web_accessible_resources"' manifest.json; then
          echo "üìÑ Web accessible resources defined"
        fi
        
        echo "‚úÖ Manifest security audit completed"

  code-quality:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Code Quality Check
      run: |
        echo "üîç Checking code quality..."
        
        # Check for console.log statements
        if grep -r "console\.log" --include="*.js" . | grep -v "vendor" | grep -v "_locales"; then
          echo "‚ö†Ô∏è  console.log statements found - consider removing for production"
        fi
        
        # Check for debugger statements
        if grep -r "debugger" --include="*.js" . | grep -v "vendor" | grep -v "_locales"; then
          echo "‚ùå debugger statements found - remove before production"
          exit 1
        fi
        
        # Check file sizes
        echo "üìä File sizes:"
        find . -name "*.js" -o -name "*.html" -o -name "*.css" | grep -v "vendor" | grep -v "_locales" | xargs ls -la | head -10
        
        echo "‚úÖ Code quality check completed"