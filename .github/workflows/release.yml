name: Release - Date-Based Versioning

on:
  push:
    tags:
      - 'v*.*.*'

jobs:
  create-release:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Extract Version
      id: version
      run: |
        # Extract version from tag (e.g., v2026.02.24)
        VERSION=${GITHUB_REF#refs/tags/v}
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Extracted version: $VERSION"
    
    - name: Validate Version Format
      run: |
        VERSION=${{ steps.version.outputs.version }}
        # Check if version matches YYYY.MM.DD format
        if ! echo "$VERSION" | grep -qE '^[0-9]{4}\.[0-9]{2}\.[0-9]{2}$'; then
          echo "❌ Invalid version format: $VERSION. Expected YYYY.MM.DD"
          exit 1
        fi
        echo "✅ Version format validated: $VERSION"
    
    - name: Update Manifest Version
      run: |
        VERSION=${{ steps.version.outputs.version }}
        
        # Update manifest.json with new version
        if [ -f manifest.json ]; then
          sed -i "s/\"version\": \"[0-9.]*\"/\"version\": \"$VERSION\"/" manifest.json
          echo "✅ Updated manifest.json version to $VERSION"
        else
          echo "❌ manifest.json not found"
          exit 1
        fi
    
    - name: Create Release Package
      run: |
        VERSION=${{ steps.version.outputs.version }}
        
        # Create zip package
        zip -r "myjdownloader-extension-mv3-$VERSION.zip" . \
          -x "*.git*" \
          -x "*.github*" \
          -x "*.DS_Store" \
          -x "node_modules/*" \
          -x "test/*" \
          -x "*.log"
        
        echo "✅ Created release package: myjdownloader-extension-mv3-$VERSION.zip"
    
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ steps.version.outputs.version }}
        name: "MyJDownloader Extension MV3 v${{ steps.version.outputs.version }}"
        body: |
          ## MyJDownloader Browser Extension (Manifest V3)
          
          ### What's Changed
          - Updated to Manifest V3
          - Full compatibility with Chrome Extension Manifest V3
          - All core features working
          
          ### Installation
          1. Download `myjdownloader-extension-mv3-${{ steps.version.outputs.version }}.zip`
          2. Extract the zip file
          3. Load unpacked extension in Chrome
          
          ### Features
          - ✅ One-click downloads via context menu
          - ✅ Device selection and management
          - ✅ Click'N'Load (CNL) interception
          - ✅ In-page toolbar
          - ✅ Session persistence
          - ✅ Captcha solving support
          
          ### Technical Details
          - **Version**: ${{ steps.version.outputs.version }}
          - **Manifest**: V3
          - **License**: GPL-3.0
          
          ---
          
          This is a community-maintained Manifest V3 conversion of the MyJDownloader Browser Extension.
        files: myjdownloader-extension-mv3-${{ steps.version.outputs.version }}.zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}